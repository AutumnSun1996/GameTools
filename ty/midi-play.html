<textarea name="mml" id="mml" cols="30" rows="10">
</textarea>
<button onclick="play_sample()">Play sample</button>
<script src="js/mmlparser.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>

<script>
    const synth = new Tone.PolySynth().toDestination();
    synth.set({ detune: -1200 });

    let input = document.getElementById("mml");
    const audioContext = new AudioContext();
    input.value = `
t56v80
l16o5
r2 r4 rdc<a|>c8c<a >c8c<a >c<ag8 r>dc<a|
>c8c<a >c8ce dcc8|
r<ga>ee8ede8edegee
reee|ddddd8ce8d8.
rdc<a>c8c<a>c8c<a>c<ag8
rga>eg8geg8gedcc8
rdcdeddcd8c<a>dcc<a>c8cc&c2.
rggede<a8>deged4
rggede<g8>degdc4
rcdegagfgeedd4
rcdccdcd8e8gee8.
rggede<a8>deged4
rggede<g8>degdc4
rcdegagfgeedd8.
<g>e8dd8c8.&c2

    `;
    function play_sample() {
        console.log("play_sample", input.value);
        play(input.value);
    }
    function mtof(noteNumber) {
        return 440 * Math.pow(2, (noteNumber - 69) / 12);
    }

    function play(mml) {
        let iter = parse(mml);
        let now = synth.toSeconds();
        for (let e of iter) {
            if (e.type === "note") {
                console.log("NOTE: " + JSON.stringify(e));
                playNote(e, now);
            }
        }
    }

    function playNote(e, dt) {
        let hold = e.duration - Math.min(0.1, e.duration / 4);
        synth.triggerAttackRelease(e.note, hold, e.timestamp + dt, e.vel / 127);
    }

</script>