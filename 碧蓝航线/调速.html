<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调速计算工具</title>
</head>

<body>
    航母1
    特殊装备
    指挥猫1
    <br>
    <canvas id="canvas" width="1000" height="400"></canvas>
</body>
<script>
    'use strict';
    function calculateFixIntervalTimeline(offset, interval, duration, endAt = 120) {
        var res = [];

        while (offset < endAt) {
            var end = offset + duration;
            if (end > endAt) {
                end = endAt;
            }
            res.push([offset, end]);
            offset += interval;
        }
        return res;
    }
    function calculateUpdatedTimeline(timstamps, offset, duration) {
        var res = [];
        for (var ts of timstamps) {
            var start = ts + offset;
            res.push([start, start + duration]);
        }
        return res;
    }
    function caculateTakeOffTime(ships, endAt = 120) {
        var timeline = [];
        var result = [];
        var idx = 0;
        for (var ship of ships) {
            for (var pair of calculateFixIntervalTimeline(1.4 + (ship.firstCd || ship.cd), ship.cd, 0, endAt)) {
                timeline.push({ 'i': idx, 't': pair[0] });
            }
            ++idx;
            result.push([]);
        }
        timeline.sort((a, b) => {
            var res = 0;
            res = a.t - b.t;
            if (res !== 0) {
                return res;
            }
            // 起飞CD相同时, 按顺序排列
            res = a.i - b.i;
            return res;
        });
        // 3.两艘航母的起飞cd过于接近（小于0.5s）时会触发强制cd，较慢的航母本轮起飞时间为较快的航母起飞时间+0.5+0.1s（较晚那个航母的抬手），不影响下一轮（航母本身有双机库，下一轮装填不会受上一轮起飞影响）。
        for (var i = 1; i < timeline.length; ++i) {
            if (timeline[i].t - timeline[i - 1].t < 0.5) {
                timeline[i].t = timeline[i - 1].t + 0.6;
            }
        }
        for (var a of timeline) {
            result[a.i].push(a.t);
        }
        return result;
    }
    function randomChoice(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }
    function randomColor() {
        return '#' + ('00000' + (Math.random() * (1 << 24) | 0).toString(16)).slice(-6);
    }
    function display(data) {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const fillHeight = 20;
        canvas.width = document.body.clientWidth;
        canvas.height = data.length * fillHeight;
        // 背景颜色
        ctx.fillStyle = 'gray';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        let max_x = 60;
        for (var part of data) {
            for (var chunk of part.pairs) {
                max_x = Math.max(max_x, chunk[1]);
            }
        }
        max_x = max_x + 5;
        console.log('Max X:', max_x);
        const ratio = canvas.width / max_x;

        let height = 0;
        for (var part of data) {
            var color = part.color;
            if (!color) {
                color = randomColor();
            }
            ctx.fillStyle = color;
            for (var chunk of part.pairs) {
                // console.log('fill', chunk[0], chunk[1])
                let x0 = chunk[0] * ratio;
                let x1 = chunk[1] * ratio;
                ctx.fillRect(x0, height, x1 - x0, fillHeight);
            }
            ctx.font = fillHeight + "px sans-serif";
            ctx.fillStyle = 'white';
            if (part.text) {
                ctx.fillText(part.text, 2, height + fillHeight - 2);
            }
            ctx.font = parseInt(fillHeight * 0.7) + "px sans-serif";
            for (var chunk of part.pairs) {
                let x0 = chunk[0] * ratio;
                ctx.fillText(chunk[0].toFixed(1), x0 + 2, height + fillHeight - 1);
            }
            height = height + fillHeight;
        }
    }
    function caculateTimeRequirements(ships, endAt) {
        var res = []
        // 流星需要减速buff的时间: 命中前1s -> 命中时
        var takeOffTimes = caculateTakeOffTime(ships, endAt);
        for (var i = 0; i < ships.length; ++i) {
            var ship = ships[i];
            var timestamps = takeOffTimes[i];
            console.log('起飞时间', ship.name, timestamps);
            if (ship.bindSkills) {
                for (var skill of ship.bindSkills) {
                    res.push({
                        text: ship.name + '-' + skill.name,
                        pairs: calculateUpdatedTimeline(timestamps, skill.offset, skill.duration)
                    });
                }
            }
            for (var equip of ship.equipments) {
                res.push({
                    text: ship.name + '-' + equip.name,
                    pairs: calculateUpdatedTimeline(timestamps, equip.offset, equip.duration)
                });
            }
        }
        return res;
    }

    display([
        {
            color: 'red',
            text: '海妈新轴',
            pairs: calculateFixIntervalTimeline(16, 20, 8, 90)
        }, {
            color: 'green',
            text: 'Meta海伦娜·站桩',
            pairs: [
                [20.6, 23.6],
                [33.6, 40.6],
                [41.5, 45.1],
                [45.1, 47.1],
                [57.1, 61.1],
                [66.1, 70.1],
                [70.6, 75.6],
            ]
        }, {
            color: 'blue',
            text: '海妈旧轴',
            pairs: calculateFixIntervalTimeline(20, 20, 8, 90)
        },
        ...caculateTimeRequirements(
            [
                {
                    name: '信浓', cd: 23.42 * 0.96,
                    equipments: [
                        {
                            name: '流星',
                            offset: 1.4,
                            duration: 1,
                        },
                        {
                            name: 'SB2C',
                            offset: 1.5,
                            duration: 0.2,
                        },
                    ]
                },
                {
                    name: '皇家方舟', cd: 23.75 * 0.96,
                    bindSkills: [
                        {
                            name: '减速',
                            offset: 0,
                            duration: 8,
                        }
                    ],
                    equipments: [
                        {
                            name: '流星',
                            offset: 1.4,
                            duration: 1,
                        },
                        {
                            name: 'SB2C',
                            offset: 1.5,
                            duration: 0.2,
                        },
                    ]
                },
                {
                    name: '半人马', cd: 21.33,
                    bindSkills: [
                        {
                            name: '减速',
                            offset: 0,
                            duration: 6,
                        },
                        {
                            name: 'Buff',
                            offset: 0,
                            duration: 8,
                        },
                    ],
                    equipments: [
                        {
                            name: '流星',
                            offset: 1.4,
                            duration: 1,
                        },
                        {
                            name: 'SB2C',
                            offset: 1.5,
                            duration: 0.2,
                        },
                    ]
                },
            ],
            90
        )
    ])
</script>

</html>
